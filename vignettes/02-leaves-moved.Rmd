---
title: "1.2: Number of leaves moved"
author: "Martin R. Smith"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: ../inst/REFERENCES.bib
csl: ../inst/apa-old-doi-prefix.csl
---

## Method

Take an unrooted ten-leaf tree:
```{R backbone, echo=FALSE, fig.width=2.4, fig.asp=0.5, message=FALSE, fig.align='center'}
library('Quartet')
library('TreeDist')
library('TreeTools')
library('TreeDistData')
backbone <- ape::read.tree(text='(a, (b, (c, (d, (((e, f), g), (h, (i, j)))))));')
par(mar = rep(0, 4))
plot(ape::unroot(backbone))
nTip <- length(backbone$tip.label)
add3 <- structure(lapply(lapply(AddTipEverywhere(backbone, '11th leaf'),
                                AddTip, 11L, '12th leaf'),
                         AddTip, 12L, '13th leaf'), class = 'multiPhylo')
add1then2 <- lapply(AddTipEverywhere(backbone, '11th leaf'), function (tr) 
  structure(lapply(AddTipEverywhere(tr, '12th leaf'), AddTip, 12L, '13th leaf'),
                       class='multiPhylo')) 
add2then1 <- lapply(AddTipEverywhere(backbone, '12th leaf'), function (tr)
    structure(lapply(AddTipEverywhere(tr, '11th leaf'), AddTip, 11L, '13th leaf'),
  class = 'multiPhylo')
  )
```

The backbone tree has `r length(backbone$tip.label)` leaves;
`r length(add3)` test trees were generated by adding an clade of three 
leaves at each of the `r length(add3)` edges of the unrooted backbone tree.

These are trees A1-A17.

```{r, echo=FALSE, fig.width=7.2, fig.asp=3/6}
par(mfrow = c(3, 6), mar = rep(0.2, 4))
urt <- lapply(add3, unroot)
lapply(urt, plot) -> XX
```

For each of these trees -- we'll consider A1 first -- we can then move 
the eleventh leaf to each of the other edges of the tree, giving trees 
B1.1-B1.19:

```{r, echo=FALSE, fig.asp=4/5}
par(mfrow = c(4, 5), mar = rep(0.2, 4))
urt <- lapply(add1then2[[1]], unroot)
lapply(urt, plot) -> XX
```

or the cherry containing the twelfth and thirteenth, giving trees C1.1 to C1.19:

```{r, echo=FALSE, fig.asp=4/5}
par(mfrow = c(4, 5), mar = rep(0.2, 4))
urt <- lapply(add2then1[[1]], unroot)
lapply(urt, plot) -> XX
```

We then expect the distance from Ai to Bi.j
(i.e. move one tip to a new location)
to be less than the distance from Ai to Ci.j
(i.e. move two tips to the same location)

```{r, echo=FALSE, fig.width=7.2, fig.asp=4/5, message=FALSE}
methods <- tdMethods[!tdMethods %in% c('mafi', 'masti')]

baddies <- vapply(seq_along(add3), function(i) {
  move1 <- AllDists(add2then1[[i]], add3[[i]])
  move2 <- AllDists(add1then2[[i]], add3[[i]])
  move1[c('mast', 'masti'), ] <- -move1[c('mast', 'masti'), ]
  move2[c('mast', 'masti'), ] <- -move2[c('mast', 'masti'), ]
  rowSums(move2 <= move1)
}, double(21))
```

## Results

```{r, output='asis', echo=FALSE}
errors <- t(t(rowSums(baddies) - (2 * length(add3))))
dimnames(errors) <- list(tdMdAbbrevs[rownames(errors)], 'Inconsistencies')
knitr::kable(errors)
```
