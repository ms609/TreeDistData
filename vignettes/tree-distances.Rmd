---
title: "Measuring tree distance"
author: "Martin R. Smith"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: ../inst/REFERENCES.bib
csl: ../inst/apa-old-doi-prefix.csl
vignette: >
  %\VignetteIndexEntry{Measuring tree similarity}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Expected tree distance of random tree pair

This figure shows how the normalized tree distance varies with the number of 
tips in the trees being compared.

Metrics marked with &#9660; are normalized based on the maximum possible value;
information-based metrics, marked `+`, are normalized against the total 
information content of each pair of trees; metrics marked `Ã—` do not have a 
readily calculated maximum value and are thus crudely normalized against a 
simple function of the number of tips.

```{R Tree-distance-averages, echo=FALSE, message=FALSE, cache=TRUE, fig.asp=1, fig.width=6, out.width='90%', fig.align='center'}
cbPalette8 <- Ternary::cbPalette8
AddLine <- function (dat, col, pch=3) {
  nLeaves <- colnames(dat)
  points(nLeaves, dat['mean', ], pch=pch, col=col)
  lines(nLeaves, dat['mean', ] + dat['sd', ], lty=3, col=col)
  lines(nLeaves, dat['mean', ] - dat['sd', ], lty=3, col=col)
}

data('randomTreeDistances', package='TreeDist')
dists <- randomTreeDistances
hi2lo <- c('vai', 'vci', 'nts', 'qd', 'vpi', 'msd', 'path', 'spr', 'rf')

plot(as.integer(dimnames(dists)[[3]]), dists['vai', 'mean', ],
     pch='.', ylim=c(0.25, 1), col='white',
     xlab = "Number of tips", ylab = "Normalized tree distance")
for (i in 1:5) AddLine(dists[hi2lo[i], , ], 
                       pch=c(3, 3, 6, 3, 3)[i],
                       col=cbPalette8[i])

nLeaves <- as.integer(dimnames(dists)[[3]])
# Crude normalization against diameter
AddLine(dists['msd', , ] / rep((nLeaves * nLeaves * 3 / 8), each=2), 
        pch=4, col=cbPalette8[6])
AddLine(dists['path', , ] / rep((nLeaves * 8), each=2),
        pch=4, col=cbPalette8[7])
AddLine(dists['spr', , ], col=cbPalette8[8], pch=4)
AddLine(dists['rf', , ], col=cbPalette8[8], pch=6)


legend('bottomright', bty='n', pch=c(3, 3, 6, 3, 3, 4,4,4,6), 
       legend=c('Var. Arb Info', 'Var. Clustering Info', 'Nye et al.',
                'Quartet', 'Var. Partition Info',
                'Matching Splits', 'Path', 'SPR',
                'Robinson-Foulds'), 
       col=cbPalette8[c(1:5, 6, 7, 8, 8)])
```


## Distribution of tree distances

```{r load-data-dists, include=FALSE}
data('distanceDistribution25', package='TreeDist')
dists <- distanceDistribution25
```

The histograms below depict the distribution of tree distances for `r dim(dists)[2]`
pairs of trees drawn at random from the uniform distribution.

```{R Tree-distance-distributions, echo=FALSE, message=FALSE, cache=TRUE, fig.asp=1, fig.width=6, out.width='90%', fig.align='center'}
par(mfrow=c(3, 3), mar=rep(1.9, 4), cex=0.8, oma=c(0, 0, 2, 0))
manyBreaks <- seq(0, 1, length.out=40)

PlotHist <- function (distances, breaks, title, ...) {
  hist(distances, xlab=NULL, main=NULL, breaks=breaks, cex=0.8, ...)
  legend('topleft', bty='n', c('', '', title), cex=0.8)
}

PlotHist(dists['vai', ], manyBreaks, 'Var. Arb Info', border=cbPalette8[1])
mtext('Distance between pectinate tree (above) and random bifurcating trees', outer=TRUE, cex=0.8)

PlotHist(dists['vci', ], manyBreaks, 'Var. Clustering Info', border=cbPalette8[2])
PlotHist(dists['nts', ], manyBreaks, 'Nye et al.', border=cbPalette8[3])
PlotHist(dists['qd', ],  manyBreaks,  'Quartet dissimilarity', border=cbPalette8[4])
PlotHist(dists['vpi', ], manyBreaks, 'Var. Partition Info', border=cbPalette8[5])
PlotHist(dists['msd', ],  manyBreaks * max(dists['msd', ]),  'Matching Splits', border=cbPalette8[6])
PlotHist(dists['path', ],  manyBreaks * max(dists['path', ]),  'Path', border=cbPalette8[7])
PlotHist(dists['spr', ], 0:max(dists['spr', ]),  'SPR', border=cbPalette8[8])
PlotHist(dists['rf', ],  manyBreaks * 44,  'Robinson-Foulds', border=cbPalette8[8])

```

# Distances between all 7-tip trees 

```{r 7-tip-treess, echo=FALSE, message=FALSE, cache=TRUE, fig.asp=3/2, fig.width=6, out.width='90%', fig.align='center'}
par(mfrow=c(3, 2), mar=rep(0.8, 4))
pal <- viridisLite::viridis(32)

PlotMDS <- function(distances, title='') {
  space <- MASS::isoMDS(distances, k=2, trace=FALSE)
  pts <- space$points
  plot(pts, pch=19, col=paste0(treeCols[as.character(shapes)], '88'), 
       xlim = range(pts[, 1]) + c(-1, 1),
       ylim=range(pts[, 2]) + c(-1, 1))
  z <- MASS::kde2d(pts[, 1], pts[, 2])
  contour(z, add=TRUE, col='#00000088')
  legend('bottom', legend=paste0('stress = ', signif(space$stress, 3)), bty='n')
  legend('top', legend=title, bty='n', text.font=2)
}
TableImage <- function (distances) {
  x <- rep(seq_len(945), each=945L)
  y <- rep(seq_len(945), 945L)
  plot(-100, -100, pch='.', col='white', ylim=c(0, 965), xlim=c(965, 0),
     axes=FALSE, xlab='', ylab='')
  shapeSizes <- table(shapes)
  shapeSum <- cumsum(shapeSizes)
  shapeStarts <-  shapeSum - shapeSizes
  rect(shapeStarts, 955, shapeSum, 965, col=Ternary::cbPalette8[2:7], border=NA)
  rect(955, shapeStarts, 965, shapeSum, col=Ternary::cbPalette8[2:7], border=NA)

  rect(x - 1L, y - 1L, xs, ys, col=pal[cut(distances, length(pal), labels=FALSE)], border=NA)
}

shapes <- treeShapes[order(treeShapes)]
treeCols <- Ternary::cbPalette8[2:7]
names(treeCols) <- unique(shapes)

hist(vaiDist, breaks=0:32, col=pal)
hist(vaiDist, breaks=0:32, col=pal)
TableImage(vaiDist)
TableImage(vaiDist)
PlotMDS(vaiDist, 'V of Arb Info')
PlotMDS(vaiDist, 'V of Arb Info')

```
